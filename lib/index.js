!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("crypto")):"function"==typeof define&&define.amd?define(["crypto"],e):(t=t||self).LGE=e(t.crypto)}(this,(function(t){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,r)};function r(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}function n(t){return"function"==typeof t}var o=!1,i={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){t&&(new Error).stack;o=t},get useDeprecatedSynchronousErrorHandling(){return o}};function s(t){setTimeout((function(){throw t}),0)}var u={closed:!0,next:function(t){},error:function(t){if(i.useDeprecatedSynchronousErrorHandling)throw t;s(t)},complete:function(){}},c=function(){return Array.isArray||function(t){return t&&"number"==typeof t.length}}();function a(t){return null!==t&&"object"==typeof t}var h=function(){function t(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}return t.prototype=Object.create(Error.prototype),t}(),l=function(){function t(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}return t.prototype.unsubscribe=function(){var e;if(!this.closed){var r=this._parentOrParents,o=this._ctorUnsubscribe,i=this._unsubscribe,s=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof t)r.remove(this);else if(null!==r)for(var u=0;u<r.length;++u){r[u].remove(this)}if(n(i)){o&&(this._unsubscribe=void 0);try{i.call(this)}catch(t){e=t instanceof h?f(t.errors):[t]}}if(c(s)){u=-1;for(var l=s.length;++u<l;){var p=s[u];if(a(p))try{p.unsubscribe()}catch(t){e=e||[],t instanceof h?e=e.concat(f(t.errors)):e.push(t)}}}if(e)throw new h(e)}},t.prototype.add=function(e){var r=e;if(!e)return t.EMPTY;switch(typeof e){case"function":r=new t(e);case"object":if(r===this||r.closed||"function"!=typeof r.unsubscribe)return r;if(this.closed)return r.unsubscribe(),r;if(!(r instanceof t)){var n=r;(r=new t)._subscriptions=[n]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var o=r._parentOrParents;if(null===o)r._parentOrParents=this;else if(o instanceof t){if(o===this)return r;r._parentOrParents=[o,this]}else{if(-1!==o.indexOf(this))return r;o.push(this)}var i=this._subscriptions;return null===i?this._subscriptions=[r]:i.push(r),r},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var r=e.indexOf(t);-1!==r&&e.splice(r,1)}},t.EMPTY=function(t){return t.closed=!0,t}(new t),t}();function f(t){return t.reduce((function(t,e){return t.concat(e instanceof h?e.errors:e)}),[])}var p=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),b=function(t){function e(r,n,o){var i=t.call(this)||this;switch(i.syncErrorValue=null,i.syncErrorThrown=!1,i.syncErrorThrowable=!1,i.isStopped=!1,arguments.length){case 0:i.destination=u;break;case 1:if(!r){i.destination=u;break}if("object"==typeof r){r instanceof e?(i.syncErrorThrowable=r.syncErrorThrowable,i.destination=r,r.add(i)):(i.syncErrorThrowable=!0,i.destination=new d(i,r));break}default:i.syncErrorThrowable=!0,i.destination=new d(i,r,n,o)}return i}return r(e,t),e.prototype[p]=function(){return this},e.create=function(t,r,n){var o=new e(t,r,n);return o.syncErrorThrowable=!1,o},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},e}(l),d=function(t){function e(e,r,o,i){var s,c=t.call(this)||this;c._parentSubscriber=e;var a=c;return n(r)?s=r:r&&(s=r.next,o=r.error,i=r.complete,r!==u&&(n((a=Object.create(r)).unsubscribe)&&c.add(a.unsubscribe.bind(a)),a.unsubscribe=c.unsubscribe.bind(c))),c._context=a,c._next=s,c._error=o,c._complete=i,c}return r(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;i.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,r=i.useDeprecatedSynchronousErrorHandling;if(this._error)r&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)r?(e.syncErrorValue=t,e.syncErrorThrown=!0):s(t),this.unsubscribe();else{if(this.unsubscribe(),r)throw t;s(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var r=function(){return t._complete.call(t._context)};i.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,r),this.unsubscribe()):(this.__tryOrUnsub(r),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),i.useDeprecatedSynchronousErrorHandling)throw t;s(t)}},e.prototype.__tryOrSetError=function(t,e,r){if(!i.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,r)}catch(e){return i.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(s(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(b);var v=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function y(t){return t}function _(t){return 0===t.length?y:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var g=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var r=new t;return r.source=this,r.operator=e,r},t.prototype.subscribe=function(t,e,r){var n=this.operator,o=function(t,e,r){if(t){if(t instanceof b)return t;if(t[p])return t[p]()}return t||e||r?new b(t,e,r):new b(u)}(t,e,r);if(n?o.add(n.call(o,this.source)):o.add(this.source||i.useDeprecatedSynchronousErrorHandling&&!o.syncErrorThrowable?this._subscribe(o):this._trySubscribe(o)),i.useDeprecatedSynchronousErrorHandling&&o.syncErrorThrowable&&(o.syncErrorThrowable=!1,o.syncErrorThrown))throw o.syncErrorValue;return o},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){i.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(t){for(;t;){var e=t,r=e.closed,n=e.destination,o=e.isStopped;if(r||o)return!1;t=n&&n instanceof b?n:null}return!0}(t)?console.warn(e):t.error(e)}},t.prototype.forEach=function(t,e){var r=this;return new(e=E(e))((function(e,n){var o;o=r.subscribe((function(e){try{t(e)}catch(t){n(t),o&&o.unsubscribe()}}),n,e)}))},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[v]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:_(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=E(t))((function(t,r){var n;e.subscribe((function(t){return n=t}),(function(t){return r(t)}),(function(){return t(n)}))}))},t.create=function(e){return new t(e)},t}();function E(t){if(t||(t=Promise),!t)throw new Error("no Promise impl found");return t}var w=function(){function t(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return t.prototype=Object.create(Error.prototype),t}(),j=function(t){function e(e,r){var n=t.call(this)||this;return n.subject=e,n.subscriber=r,n.closed=!1,n}return r(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var r=e.indexOf(this.subscriber);-1!==r&&e.splice(r,1)}}},e}(l),S=function(t){function e(e){var r=t.call(this,e)||this;return r.destination=e,r}return r(e,t),e}(b),m=function(t){function e(){var e=t.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return r(e,t),e.prototype[p]=function(){return new S(this)},e.prototype.lift=function(t){var e=new x(this,this);return e.operator=t,e},e.prototype.next=function(t){if(this.closed)throw new w;if(!this.isStopped)for(var e=this.observers,r=e.length,n=e.slice(),o=0;o<r;o++)n[o].next(t)},e.prototype.error=function(t){if(this.closed)throw new w;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,r=e.length,n=e.slice(),o=0;o<r;o++)n[o].error(t);this.observers.length=0},e.prototype.complete=function(){if(this.closed)throw new w;this.isStopped=!0;for(var t=this.observers,e=t.length,r=t.slice(),n=0;n<e;n++)r[n].complete();this.observers.length=0},e.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},e.prototype._trySubscribe=function(e){if(this.closed)throw new w;return t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){if(this.closed)throw new w;return this.hasError?(t.error(this.thrownError),l.EMPTY):this.isStopped?(t.complete(),l.EMPTY):(this.observers.push(t),new j(this,t))},e.prototype.asObservable=function(){var t=new g;return t.source=this,t},e.create=function(t,e){return new x(t,e)},e}(g),x=function(t){function e(e,r){var n=t.call(this)||this;return n.destination=e,n.source=r,n}return r(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):l.EMPTY},e}(m),O=function(t){function e(e){var r=t.call(this)||this;return r._value=e,r}return r(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),e.prototype._subscribe=function(e){var r=t.prototype._subscribe.call(this,e);return r&&!r.closed&&e.next(this._value),r},e.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new w;return this._value},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},e}(m),T=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.scheduler=e,n.work=r,n.pending=!1,n}return r(e,t),e.prototype.schedule=function(t,e){if(void 0===e&&(e=0),this.closed)return this;this.state=t;var r=this.id,n=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(n,r,e)),this.pending=!0,this.delay=e,this.id=this.id||this.requestAsyncId(n,this.id,e),this},e.prototype.requestAsyncId=function(t,e,r){return void 0===r&&(r=0),setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,e,r){if(void 0===r&&(r=0),null!==r&&this.delay===r&&!1===this.pending)return e;clearInterval(e)},e.prototype.execute=function(t,e){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,e);if(r)return r;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,e){var r=!1,n=void 0;try{this.work(t)}catch(t){r=!0,n=!!t&&t||new Error(t)}if(r)return this.unsubscribe(),n},e.prototype._unsubscribe=function(){var t=this.id,e=this.scheduler,r=e.actions,n=r.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==n&&r.splice(n,1),null!=t&&(this.id=this.recycleAsyncId(e,t,null)),this.delay=null},e}(function(t){function e(e,r){return t.call(this)||this}return r(e,t),e.prototype.schedule=function(t,e){return this},e}(l)),A=function(){function t(e,r){void 0===r&&(r=t.now),this.SchedulerAction=e,this.now=r}return t.prototype.schedule=function(t,e,r){return void 0===e&&(e=0),new this.SchedulerAction(this,t).schedule(r,e)},t.now=function(){return Date.now()},t}();function M(t){return t&&"function"==typeof t.schedule}var P=function(t){return function(e){for(var r=0,n=t.length;r<n&&!e.closed;r++)e.next(t[r]);e.complete()}};function I(t,e){return new g((function(r){var n=new l,o=0;return n.add(e.schedule((function(){o!==t.length?(r.next(t[o++]),r.closed||n.add(this.schedule())):r.complete()}))),n}))}function R(t,e){return e?I(t,e):new g(P(t))}function k(t){var e=t.error;t.subscriber.error(e)}var C=new(function(t){function e(r,n){void 0===n&&(n=A.now);var o=t.call(this,r,(function(){return e.delegate&&e.delegate!==o?e.delegate.now():n()}))||this;return o.actions=[],o.active=!1,o.scheduled=void 0,o}return r(e,t),e.prototype.schedule=function(r,n,o){return void 0===n&&(n=0),e.delegate&&e.delegate!==this?e.delegate.schedule(r,n,o):t.prototype.schedule.call(this,r,n,o)},e.prototype.flush=function(t){var e=this.actions;if(this.active)e.push(t);else{var r;this.active=!0;do{if(r=t.execute(t.state,t.delay))break}while(t=e.shift());if(this.active=!1,r){for(;t=e.shift();)t.unsubscribe();throw r}}},e}(A))(T),N=function(){function t(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return t.prototype=Object.create(Error.prototype),t}();function z(t,e){return function(r){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return r.lift(new $(t,e))}}var $=function(){function t(t,e){this.project=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new F(t,this.project,this.thisArg))},t}(),F=function(t){function e(e,r,n){var o=t.call(this,e)||this;return o.project=r,o.count=0,o.thisArg=n||o,o}return r(e,t),e.prototype._next=function(t){var e;try{e=this.project.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(b),L=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.notifyNext=function(t,e,r,n,o){this.destination.next(e)},e.prototype.notifyError=function(t,e){this.destination.error(t)},e.prototype.notifyComplete=function(t){this.destination.complete()},e}(b),V=function(t){function e(e,r,n){var o=t.call(this)||this;return o.parent=e,o.outerValue=r,o.outerIndex=n,o.index=0,o}return r(e,t),e.prototype._next=function(t){this.parent.notifyNext(this.outerValue,t,this.outerIndex,this.index++,this)},e.prototype._error=function(t){this.parent.notifyError(t,this),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},e}(b);function D(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var U=D(),q=function(t){return t&&"number"==typeof t.length&&"function"!=typeof t};function B(t){return!!t&&"function"!=typeof t.subscribe&&"function"==typeof t.then}var H=function(t){if(t&&"function"==typeof t[v])return n=t,function(t){var e=n[v]();if("function"!=typeof e.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return e.subscribe(t)};if(q(t))return P(t);if(B(t))return r=t,function(t){return r.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,s),t};if(t&&"function"==typeof t[U])return e=t,function(t){for(var r=e[U]();;){var n=void 0;try{n=r.next()}catch(e){return t.error(e),t}if(n.done){t.complete();break}if(t.next(n.value),t.closed)break}return"function"==typeof r.return&&t.add((function(){r.return&&r.return()})),t};var e,r,n,o=a(t)?"an invalid object":"'"+t+"'";throw new TypeError("You provided "+o+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function G(t,e,r,n,o){if(void 0===o&&(o=new V(t,r,n)),!o.closed)return e instanceof g?e.subscribe(o):H(e)(o)}var Y={};var K=function(){function t(t){this.resultSelector=t}return t.prototype.call=function(t,e){return e.subscribe(new W(t,this.resultSelector))},t}(),W=function(t){function e(e,r){var n=t.call(this,e)||this;return n.resultSelector=r,n.active=0,n.values=[],n.observables=[],n}return r(e,t),e.prototype._next=function(t){this.values.push(Y),this.observables.push(t)},e.prototype._complete=function(){var t=this.observables,e=t.length;if(0===e)this.destination.complete();else{this.active=e,this.toRespond=e;for(var r=0;r<e;r++){var n=t[r];this.add(G(this,n,void 0,r))}}},e.prototype.notifyComplete=function(t){0==(this.active-=1)&&this.destination.complete()},e.prototype.notifyNext=function(t,e,r){var n=this.values,o=n[r],i=this.toRespond?o===Y?--this.toRespond:this.toRespond:0;n[r]=e,0===i&&(this.resultSelector?this._tryResultSelector(n):this.destination.next(n.slice()))},e.prototype._tryResultSelector=function(t){var e;try{e=this.resultSelector.apply(this,t)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(L);function J(t,e){if(null!=t){if(function(t){return t&&"function"==typeof t[v]}(t))return function(t,e){return new g((function(r){var n=new l;return n.add(e.schedule((function(){var o=t[v]();n.add(o.subscribe({next:function(t){n.add(e.schedule((function(){return r.next(t)})))},error:function(t){n.add(e.schedule((function(){return r.error(t)})))},complete:function(){n.add(e.schedule((function(){return r.complete()})))}}))}))),n}))}(t,e);if(B(t))return function(t,e){return new g((function(r){var n=new l;return n.add(e.schedule((function(){return t.then((function(t){n.add(e.schedule((function(){r.next(t),n.add(e.schedule((function(){return r.complete()})))})))}),(function(t){n.add(e.schedule((function(){return r.error(t)})))}))}))),n}))}(t,e);if(q(t))return I(t,e);if(function(t){return t&&"function"==typeof t[U]}(t)||"string"==typeof t)return function(t,e){if(!t)throw new Error("Iterable cannot be null");return new g((function(r){var n,o=new l;return o.add((function(){n&&"function"==typeof n.return&&n.return()})),o.add(e.schedule((function(){n=t[U](),o.add(e.schedule((function(){if(!r.closed){var t,e;try{var o=n.next();t=o.value,e=o.done}catch(t){return void r.error(t)}e?r.complete():(r.next(t),this.schedule())}})))}))),o}))}(t,e)}throw new TypeError((null!==t&&typeof t||t)+" is not observable")}var X=function(t){function e(e){var r=t.call(this)||this;return r.parent=e,r}return r(e,t),e.prototype._next=function(t){this.parent.notifyNext(t)},e.prototype._error=function(t){this.parent.notifyError(t),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},e}(b),Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.notifyNext=function(t){this.destination.next(t)},e.prototype.notifyError=function(t){this.destination.error(t)},e.prototype.notifyComplete=function(){this.destination.complete()},e}(b);function Z(t,e){return function(r){return r.lift(new tt(t,e))}}var tt=function(){function t(t,e){this.predicate=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new et(t,this.predicate,this.thisArg))},t}(),et=function(t){function e(e,r,n){var o=t.call(this,e)||this;return o.predicate=r,o.thisArg=n,o.count=0,o}return r(e,t),e.prototype._next=function(t){var e;try{e=this.predicate.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}e&&this.destination.next(t)},e}(b);function rt(t,e){return function(r){return r.lift(new nt(t,e))}}var nt=function(){function t(t,e){this.compare=t,this.keySelector=e}return t.prototype.call=function(t,e){return e.subscribe(new ot(t,this.compare,this.keySelector))},t}(),ot=function(t){function e(e,r,n){var o=t.call(this,e)||this;return o.keySelector=n,o.hasKey=!1,"function"==typeof r&&(o.compare=r),o}return r(e,t),e.prototype.compare=function(t,e){return t===e},e.prototype._next=function(t){var e;try{var r=this.keySelector;e=r?r(t):t}catch(t){return this.destination.error(t)}var n=!1;if(this.hasKey)try{n=(0,this.compare)(this.key,e)}catch(t){return this.destination.error(t)}else this.hasKey=!0;n||(this.key=e,this.destination.next(t))},e}(b);function it(t,e,r){return void 0===r&&(r=C),function(n){var o,i=(o=t)instanceof Date&&!isNaN(+o),s=i?+t-r.now():Math.abs(t);return n.lift(new st(s,i,e,r))}}var st=function(){function t(t,e,r,n){this.waitFor=t,this.absoluteTimeout=e,this.withObservable=r,this.scheduler=n}return t.prototype.call=function(t,e){return e.subscribe(new ut(t,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},t}(),ut=function(t){function e(e,r,n,o,i){var s=t.call(this,e)||this;return s.absoluteTimeout=r,s.waitFor=n,s.withObservable=o,s.scheduler=i,s.scheduleTimeout(),s}return r(e,t),e.dispatchTimeout=function(t){var e=t.withObservable;t._unsubscribeAndRecycle(),t.add(function(t,e){if(!e.closed)return t instanceof g?t.subscribe(e):H(t)(e)}(e,new X(t)))},e.prototype.scheduleTimeout=function(){var t=this.action;t?this.action=t.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(e.dispatchTimeout,this.waitFor,this))},e.prototype._next=function(e){this.absoluteTimeout||this.scheduleTimeout(),t.prototype._next.call(this,e)},e.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},e}(Q);function ct(t,e){return void 0===e&&(e=C),it(t,function(t,e){return new g(e?function(r){return e.schedule(k,0,{error:t,subscriber:r})}:function(e){return e.error(t)})}(new N),e)}var at=function(){this.__data__=[],this.size=0};var ht=function(t,e){return t===e||t!=t&&e!=e};var lt=function(t,e){for(var r=t.length;r--;)if(ht(t[r][0],e))return r;return-1},ft=Array.prototype.splice;var pt=function(t){var e=this.__data__,r=lt(e,t);return!(r<0)&&(r==e.length-1?e.pop():ft.call(e,r,1),--this.size,!0)};var bt=function(t){var e=this.__data__,r=lt(e,t);return r<0?void 0:e[r][1]};var dt=function(t){return lt(this.__data__,t)>-1};var vt=function(t,e){var r=this.__data__,n=lt(r,t);return n<0?(++this.size,r.push([t,e])):r[n][1]=e,this};function yt(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}yt.prototype.clear=at,yt.prototype.delete=pt,yt.prototype.get=bt,yt.prototype.has=dt,yt.prototype.set=vt;var _t=yt;var gt=function(){this.__data__=new _t,this.size=0};var Et=function(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r};var wt=function(t){return this.__data__.get(t)};var jt=function(t){return this.__data__.has(t)},St="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function mt(t,e){return t(e={exports:{}},e.exports),e.exports}var xt="object"==typeof St&&St&&St.Object===Object&&St,Ot="object"==typeof self&&self&&self.Object===Object&&self,Tt=xt||Ot||Function("return this")(),At=Tt.Symbol,Mt=Object.prototype,Pt=Mt.hasOwnProperty,It=Mt.toString,Rt=At?At.toStringTag:void 0;var kt=function(t){var e=Pt.call(t,Rt),r=t[Rt];try{t[Rt]=void 0;var n=!0}catch(t){}var o=It.call(t);return n&&(e?t[Rt]=r:delete t[Rt]),o},Ct=Object.prototype.toString;var Nt=function(t){return Ct.call(t)},zt=At?At.toStringTag:void 0;var $t=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":zt&&zt in Object(t)?kt(t):Nt(t)};var Ft=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};var Lt,Vt=function(t){if(!Ft(t))return!1;var e=$t(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e},Dt=Tt["__core-js_shared__"],Ut=(Lt=/[^.]+$/.exec(Dt&&Dt.keys&&Dt.keys.IE_PROTO||""))?"Symbol(src)_1."+Lt:"";var qt=function(t){return!!Ut&&Ut in t},Bt=Function.prototype.toString;var Ht=function(t){if(null!=t){try{return Bt.call(t)}catch(t){}try{return t+""}catch(t){}}return""},Gt=/^\[object .+?Constructor\]$/,Yt=Function.prototype,Kt=Object.prototype,Wt=Yt.toString,Jt=Kt.hasOwnProperty,Xt=RegExp("^"+Wt.call(Jt).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var Qt=function(t){return!(!Ft(t)||qt(t))&&(Vt(t)?Xt:Gt).test(Ht(t))};var Zt=function(t,e){return null==t?void 0:t[e]};var te=function(t,e){var r=Zt(t,e);return Qt(r)?r:void 0},ee=te(Tt,"Map"),re=te(Object,"create");var ne=function(){this.__data__=re?re(null):{},this.size=0};var oe=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},ie=Object.prototype.hasOwnProperty;var se=function(t){var e=this.__data__;if(re){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return ie.call(e,t)?e[t]:void 0},ue=Object.prototype.hasOwnProperty;var ce=function(t){var e=this.__data__;return re?void 0!==e[t]:ue.call(e,t)};var ae=function(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=re&&void 0===e?"__lodash_hash_undefined__":e,this};function he(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}he.prototype.clear=ne,he.prototype.delete=oe,he.prototype.get=se,he.prototype.has=ce,he.prototype.set=ae;var le=he;var fe=function(){this.size=0,this.__data__={hash:new le,map:new(ee||_t),string:new le}};var pe=function(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t};var be=function(t,e){var r=t.__data__;return pe(e)?r["string"==typeof e?"string":"hash"]:r.map};var de=function(t){var e=be(this,t).delete(t);return this.size-=e?1:0,e};var ve=function(t){return be(this,t).get(t)};var ye=function(t){return be(this,t).has(t)};var _e=function(t,e){var r=be(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this};function ge(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}ge.prototype.clear=fe,ge.prototype.delete=de,ge.prototype.get=ve,ge.prototype.has=ye,ge.prototype.set=_e;var Ee=ge;var we=function(t,e){var r=this.__data__;if(r instanceof _t){var n=r.__data__;if(!ee||n.length<199)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new Ee(n)}return r.set(t,e),this.size=r.size,this};function je(t){var e=this.__data__=new _t(t);this.size=e.size}je.prototype.clear=gt,je.prototype.delete=Et,je.prototype.get=wt,je.prototype.has=jt,je.prototype.set=we;var Se=je;var me=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this};var xe=function(t){return this.__data__.has(t)};function Oe(t){var e=-1,r=null==t?0:t.length;for(this.__data__=new Ee;++e<r;)this.add(t[e])}Oe.prototype.add=Oe.prototype.push=me,Oe.prototype.has=xe;var Te=Oe;var Ae=function(t,e){for(var r=-1,n=null==t?0:t.length;++r<n;)if(e(t[r],r,t))return!0;return!1};var Me=function(t,e){return t.has(e)};var Pe=function(t,e,r,n,o,i){var s=1&r,u=t.length,c=e.length;if(u!=c&&!(s&&c>u))return!1;var a=i.get(t),h=i.get(e);if(a&&h)return a==e&&h==t;var l=-1,f=!0,p=2&r?new Te:void 0;for(i.set(t,e),i.set(e,t);++l<u;){var b=t[l],d=e[l];if(n)var v=s?n(d,b,l,e,t,i):n(b,d,l,t,e,i);if(void 0!==v){if(v)continue;f=!1;break}if(p){if(!Ae(e,(function(t,e){if(!Me(p,e)&&(b===t||o(b,t,r,n,i)))return p.push(e)}))){f=!1;break}}else if(b!==d&&!o(b,d,r,n,i)){f=!1;break}}return i.delete(t),i.delete(e),f},Ie=Tt.Uint8Array;var Re=function(t){var e=-1,r=Array(t.size);return t.forEach((function(t,n){r[++e]=[n,t]})),r};var ke=function(t){var e=-1,r=Array(t.size);return t.forEach((function(t){r[++e]=t})),r},Ce=At?At.prototype:void 0,Ne=Ce?Ce.valueOf:void 0;var ze=function(t,e,r,n,o,i,s){switch(r){case"[object DataView]":if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case"[object ArrayBuffer]":return!(t.byteLength!=e.byteLength||!i(new Ie(t),new Ie(e)));case"[object Boolean]":case"[object Date]":case"[object Number]":return ht(+t,+e);case"[object Error]":return t.name==e.name&&t.message==e.message;case"[object RegExp]":case"[object String]":return t==e+"";case"[object Map]":var u=Re;case"[object Set]":var c=1&n;if(u||(u=ke),t.size!=e.size&&!c)return!1;var a=s.get(t);if(a)return a==e;n|=2,s.set(t,e);var h=Pe(u(t),u(e),n,o,i,s);return s.delete(t),h;case"[object Symbol]":if(Ne)return Ne.call(t)==Ne.call(e)}return!1};var $e=function(t,e){for(var r=-1,n=e.length,o=t.length;++r<n;)t[o+r]=e[r];return t},Fe=Array.isArray;var Le=function(t,e,r){var n=e(t);return Fe(t)?n:$e(n,r(t))};var Ve=function(t,e){for(var r=-1,n=null==t?0:t.length,o=0,i=[];++r<n;){var s=t[r];e(s,r,t)&&(i[o++]=s)}return i};var De=function(){return[]},Ue=Object.prototype.propertyIsEnumerable,qe=Object.getOwnPropertySymbols,Be=qe?function(t){return null==t?[]:(t=Object(t),Ve(qe(t),(function(e){return Ue.call(t,e)})))}:De;var He=function(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n};var Ge=function(t){return null!=t&&"object"==typeof t};var Ye=function(t){return Ge(t)&&"[object Arguments]"==$t(t)},Ke=Object.prototype,We=Ke.hasOwnProperty,Je=Ke.propertyIsEnumerable,Xe=Ye(function(){return arguments}())?Ye:function(t){return Ge(t)&&We.call(t,"callee")&&!Je.call(t,"callee")};var Qe=function(){return!1},Ze=mt((function(t,e){var r=e&&!e.nodeType&&e,n=r&&t&&!t.nodeType&&t,o=n&&n.exports===r?Tt.Buffer:void 0,i=(o?o.isBuffer:void 0)||Qe;t.exports=i})),tr=/^(?:0|[1-9]\d*)$/;var er=function(t,e){var r=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&tr.test(t))&&t>-1&&t%1==0&&t<e};var rr=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991},nr={};nr["[object Float32Array]"]=nr["[object Float64Array]"]=nr["[object Int8Array]"]=nr["[object Int16Array]"]=nr["[object Int32Array]"]=nr["[object Uint8Array]"]=nr["[object Uint8ClampedArray]"]=nr["[object Uint16Array]"]=nr["[object Uint32Array]"]=!0,nr["[object Arguments]"]=nr["[object Array]"]=nr["[object ArrayBuffer]"]=nr["[object Boolean]"]=nr["[object DataView]"]=nr["[object Date]"]=nr["[object Error]"]=nr["[object Function]"]=nr["[object Map]"]=nr["[object Number]"]=nr["[object Object]"]=nr["[object RegExp]"]=nr["[object Set]"]=nr["[object String]"]=nr["[object WeakMap]"]=!1;var or=function(t){return Ge(t)&&rr(t.length)&&!!nr[$t(t)]};var ir=function(t){return function(e){return t(e)}},sr=mt((function(t,e){var r=e&&!e.nodeType&&e,n=r&&t&&!t.nodeType&&t,o=n&&n.exports===r&&xt.process,i=function(){try{var t=n&&n.require&&n.require("util").types;return t||o&&o.binding&&o.binding("util")}catch(t){}}();t.exports=i})),ur=sr&&sr.isTypedArray,cr=ur?ir(ur):or,ar=Object.prototype.hasOwnProperty;var hr=function(t,e){var r=Fe(t),n=!r&&Xe(t),o=!r&&!n&&Ze(t),i=!r&&!n&&!o&&cr(t),s=r||n||o||i,u=s?He(t.length,String):[],c=u.length;for(var a in t)!e&&!ar.call(t,a)||s&&("length"==a||o&&("offset"==a||"parent"==a)||i&&("buffer"==a||"byteLength"==a||"byteOffset"==a)||er(a,c))||u.push(a);return u},lr=Object.prototype;var fr=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||lr)};var pr=function(t,e){return function(r){return t(e(r))}}(Object.keys,Object),br=Object.prototype.hasOwnProperty;var dr=function(t){if(!fr(t))return pr(t);var e=[];for(var r in Object(t))br.call(t,r)&&"constructor"!=r&&e.push(r);return e};var vr=function(t){return null!=t&&rr(t.length)&&!Vt(t)};var yr=function(t){return vr(t)?hr(t):dr(t)};var _r=function(t){return Le(t,yr,Be)},gr=Object.prototype.hasOwnProperty;var Er=function(t,e,r,n,o,i){var s=1&r,u=_r(t),c=u.length;if(c!=_r(e).length&&!s)return!1;for(var a=c;a--;){var h=u[a];if(!(s?h in e:gr.call(e,h)))return!1}var l=i.get(t),f=i.get(e);if(l&&f)return l==e&&f==t;var p=!0;i.set(t,e),i.set(e,t);for(var b=s;++a<c;){var d=t[h=u[a]],v=e[h];if(n)var y=s?n(v,d,h,e,t,i):n(d,v,h,t,e,i);if(!(void 0===y?d===v||o(d,v,r,n,i):y)){p=!1;break}b||(b="constructor"==h)}if(p&&!b){var _=t.constructor,g=e.constructor;_==g||!("constructor"in t)||!("constructor"in e)||"function"==typeof _&&_ instanceof _&&"function"==typeof g&&g instanceof g||(p=!1)}return i.delete(t),i.delete(e),p},wr=te(Tt,"DataView"),jr=te(Tt,"Promise"),Sr=te(Tt,"Set"),mr=te(Tt,"WeakMap"),xr=Ht(wr),Or=Ht(ee),Tr=Ht(jr),Ar=Ht(Sr),Mr=Ht(mr),Pr=$t;(wr&&"[object DataView]"!=Pr(new wr(new ArrayBuffer(1)))||ee&&"[object Map]"!=Pr(new ee)||jr&&"[object Promise]"!=Pr(jr.resolve())||Sr&&"[object Set]"!=Pr(new Sr)||mr&&"[object WeakMap]"!=Pr(new mr))&&(Pr=function(t){var e=$t(t),r="[object Object]"==e?t.constructor:void 0,n=r?Ht(r):"";if(n)switch(n){case xr:return"[object DataView]";case Or:return"[object Map]";case Tr:return"[object Promise]";case Ar:return"[object Set]";case Mr:return"[object WeakMap]"}return e});var Ir=Pr,Rr=Object.prototype.hasOwnProperty;var kr=function(t,e,r,n,o,i){var s=Fe(t),u=Fe(e),c=s?"[object Array]":Ir(t),a=u?"[object Array]":Ir(e),h="[object Object]"==(c="[object Arguments]"==c?"[object Object]":c),l="[object Object]"==(a="[object Arguments]"==a?"[object Object]":a),f=c==a;if(f&&Ze(t)){if(!Ze(e))return!1;s=!0,h=!1}if(f&&!h)return i||(i=new Se),s||cr(t)?Pe(t,e,r,n,o,i):ze(t,e,c,r,n,o,i);if(!(1&r)){var p=h&&Rr.call(t,"__wrapped__"),b=l&&Rr.call(e,"__wrapped__");if(p||b){var d=p?t.value():t,v=b?e.value():e;return i||(i=new Se),o(d,v,r,n,i)}}return!!f&&(i||(i=new Se),Er(t,e,r,n,o,i))};var Cr=function t(e,r,n,o,i){return e===r||(null==e||null==r||!Ge(e)&&!Ge(r)?e!=e&&r!=r:kr(e,r,n,o,t,i))};var Nr=function(t,e){return Cr(t,e)};var zr=function(t){return"symbol"==typeof t||Ge(t)&&"[object Symbol]"==$t(t)},$r=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Fr=/^\w*$/;var Lr=function(t,e){if(Fe(t))return!1;var r=typeof t;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=t&&!zr(t))||(Fr.test(t)||!$r.test(t)||null!=e&&t in Object(e))};function Vr(t,e){if("function"!=typeof t||null!=e&&"function"!=typeof e)throw new TypeError("Expected a function");var r=function(){var n=arguments,o=e?e.apply(this,n):n[0],i=r.cache;if(i.has(o))return i.get(o);var s=t.apply(this,n);return r.cache=i.set(o,s)||i,s};return r.cache=new(Vr.Cache||Ee),r}Vr.Cache=Ee;var Dr=Vr;var Ur=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,qr=/\\(\\)?/g,Br=function(t){var e=Dr(t,(function(t){return 500===r.size&&r.clear(),t})),r=e.cache;return e}((function(t){var e=[];return 46===t.charCodeAt(0)&&e.push(""),t.replace(Ur,(function(t,r,n,o){e.push(n?o.replace(qr,"$1"):r||t)})),e}));var Hr=function(t,e){for(var r=-1,n=null==t?0:t.length,o=Array(n);++r<n;)o[r]=e(t[r],r,t);return o},Gr=At?At.prototype:void 0,Yr=Gr?Gr.toString:void 0;var Kr=function t(e){if("string"==typeof e)return e;if(Fe(e))return Hr(e,t)+"";if(zr(e))return Yr?Yr.call(e):"";var r=e+"";return"0"==r&&1/e==-1/0?"-0":r};var Wr=function(t){return null==t?"":Kr(t)};var Jr=function(t,e){return Fe(t)?t:Lr(t,e)?[t]:Br(Wr(t))};var Xr=function(t){if("string"==typeof t||zr(t))return t;var e=t+"";return"0"==e&&1/t==-1/0?"-0":e};var Qr=function(t,e){for(var r=0,n=(e=Jr(e,t)).length;null!=t&&r<n;)t=t[Xr(e[r++])];return r&&r==n?t:void 0};var Zr=function(t,e,r){var n=null==t?void 0:Qr(t,e);return void 0===n?r:n};let tn,en,rn=(e=21)=>{let r=(e=>{!tn||tn.length<e?(tn=Buffer.allocUnsafe(32*e),t.randomFillSync(tn),en=0):en+e>tn.length&&(t.randomFillSync(tn),en=0);let r=tn.subarray(en,en+e);return en+=e,r})(e),n="";for(;e--;)n+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[63&r[e]];return n};const nn="A_SET",on=["E_INITIAL","E_RESTRICT","E_FILTER","E_VALIDATE","E_PRECOMMIT","E_COMMIT","E_COMPLETE"],sn=new Map([["next",["E_INITIAL","E_FILTER","E_VALIDATE","E_PRECOMMIT","E_COMMIT","E_COMPLETE"]],[nn,[...on]],["A_ANY",["E_INITIAL","E_COMMIT","E_COMPLETE"]]]),un=["E_INITIAL","E_FILTER","E_VALIDATE","E_PRE_MAP_MERGE","E_MAP_MERGE","E_PRECOMMIT","E_COMMIT","E_COMPLETE"],cn="ABSENT",an=(t,e)=>{"string"==typeof t&&(t=new Error(t));try{e&&(t.meta=e)}catch(t){}return t},hn=t=>{if(!t)return new Map;if(t instanceof Map)return t;const e=new Map;return"object"==typeof t?([...Object.keys(t)].forEach(r=>e.set(r,t[r])),e):e},ln=t=>t;var fn=Object.freeze({__proto__:null,E_INITIAL:"E_INITIAL",E_FILTER:"E_FILTER",E_VALIDATE:"E_VALIDATE",E_PRECOMMIT:"E_PRECOMMIT",E_PRE_MAP_MERGE:"E_PRE_MAP_MERGE",E_MAP_MERGE:"E_MAP_MERGE",E_COMMIT:"E_COMMIT",E_COMPLETE:"E_COMPLETE",E_RESTRICT:"E_RESTRICT",A_NEXT:"next",A_ANY:"A_ANY",A_ACTION:"A_ACTION",A_SET:nn,A_DELETE:"A_DELETE",setEvents:on,defaultEventTree:sn,mapNextEvents:un,ABSENT:"ABSENT","Å":cn,"eqÅ":(t,e)=>void 0===e||e===cn||t===e,e:an,toMap:hn,NOOP:ln,SR_FROM_SET:"SR_FROM_SET"});const pn="action,stage,value,target".split(",");var bn=(...t)=>{const e=((t,e,r,n)=>t&&"object"==typeof t?pn.map(e=>e in t?t[e]:cn):[t,e,r,n])(...t),r=new Map;return pn.forEach((t,n)=>{if(e.length<=n)return;const o=e[n];o!==cn&&("function"==typeof o?r.set(t,o):void 0!==o&&r.set(t,t=>t===o))}),r.size||console.warn("eventFilter with no tests has been crated, with args",t),Object.assign(t=>{if("function"==typeof r.get("value")&&t.target&&t.target.debug&&console.log("----- matchEvent:",e),t.isComplete||!r.size)return"function"==typeof r.get("value")&&t.target&&t.target.debug&&console.log("----- matchEvent on complete event, returning false"),!1;const n=[...r.keys()].reduce((e,n)=>{if(!e)return e;const o=r.get(n),i=t[n];let s=!0;try{s=o(i)}catch(t){console.log("matchEvent error with ",o.toString(),"on",i),s=!1}return"function"==typeof r.get("value")&&t.target&&t.target.debug&&console.log("test of ",n,"result ",s,"for",t.toString()),s},!0);return"function"==typeof r.get("value")&&t.target&&t.target.debug&&console.log("----- matchEvent:     final result:",n,"for",t),n},{tests:r,props:e})};class dn extends O{constructor(t,e){super(t),this._initParams(e),this.id=rn()}_initParams({action:t="ABSENT",stage:e="ABSENT",target:r}){this.action=t,this.stage=e,this.target=r}get completed(){return this._completed||(this._completed=new Set),this._completed}set stage(t){this.completed.add(this.stage),this._stage=t}complete(){try{this.completed.add(this.stage),super.complete()}catch(t){throw super.delete(this.stage),t}}get stage(){return this._stage}get value(){try{return this.getValue()}catch(t){return cn}}get activeStream(){return!this.isStopped&&!this.hasError}valueToString(){try{if(null===this.value)return"null";if(void 0===this.value)return"undefined";if("object"==typeof this.value){if(this.value instanceof Map){const t=[...this.value.entries()],e={...this.value};return JSON.stringify({entries:t,props:e})}try{return JSON.stringify(this.value)}catch(t){}if("function"==typeof this.value.toString)return this.value.toString()}return""+this.value}catch(t){return console.log("error in valueToString:",t.message),""+this.value}}toString(){const t=["<<",this.id];return this.action!==cn&&t.push("action: ",this.action.toString()),this.stage!==cn&&t.push("stage:",this.stage.toString()),this.value!==cn&&t.push("value",this.valueToString()),t.push(">>"),t.join(" ")}}const vn=/^set(.+)$/i;var yn=(t,e)=>Object.assign(t,{addActions:e=>(hn(e).forEach((e,r)=>{t.addAction(r,e)}),t),_actions:hn(e),addAction:(e,r)=>"function"!=typeof r?(console.error("cannot add ",e," -- not a function",r),t):(t._actions.has(e)&&console.warn("redefining action",e),t._actions.set(e,r),delete t._doProxy,t),get do(){return t._doProxy||("undefined"==typeof Proxy?t._doProxy=(t=>{const e={};if(t._actions.forEach((r,n)=>{e[n]=(...e)=>(t.debug&&console.warn("using non-proxy action"),r(t,...e))}),"function"==typeof t.set){(t.value instanceof Map?t.value.keys():Object.keys(t.value)).forEach(r=>{e[r]=e=>(t.debug&&console.warn("using non-proxy set"),t.set(r,e))})}return e})(t):t._doProxy=(t=>new Proxy(t,{get(e,r){if("constructor"===r)return t.debug&&console.warn("--- why do we care about constructor"),null;if(e._actions.has(r))return e._amap||(e._amap=new Map),e._amap.has(r)||e._amap.set(r,(...t)=>e._actions.get(r)(e,...t)),e._amap.get(r);if("function"==typeof e.set){const t=""+r;if(vn.test(t)){const[r,n]=vn.exec(t),o=n.substr(0,1).toLowerCase()+n.substr(1);if(e.has(o))return t=>e.set(o,t);if(e.has(n))return t=>e.set(n,t)}}throw console.log("unknown action:",r,"called on stream.do"),new Error("no action "+r)}}))(t)),t._doProxy}});class _n{constructor(t,e={}){this._updateValue(t);const{name:r,debug:n=!1,finalize:o,actions:i}=e;this.name=r||"state_"+Math.random(),this.debug=n,i&&yn(this,i)}get _valueSubject(){return this._$valueSubject||(this._$valueSubject=new O),this._$valueSubject}get _errorSubject(){return this._$errorSubject||(this._$errorSubject=(new m).pipe(z(t=>t.error&&t.error.message&&!t.message?{...t,message:t.error.message}:t)),this._$errorSubject.subscribe(t=>{t&&(this._lastError=t)},ln)),this._$errorSubject}error(t,e){return Zr(t,"error")?this._errorSubject.next({...t,target:this}):this._errorSubject.next({target:this,event:e,error:t}),this}_updateValue(t){this._valueSubject.next(t)}get isStopped(){return this._valueSubject.isStopped}get closed(){return this._valueSubject.closed}next(t){this._updateValue(t)}get valueNonTrans(){return this._baseSubject?this._baseSubject.value:this.value}get value(){return this._valueSubject.value}getValue(){return this.value}complete(){this._valueSubject.complete(),this._errorSubject.complete()}subscribe(t,e,r){if(this.isStopped)throw new Error("cannot subscribe to a stopped stream");if("object"==typeof t){const{next:e,error:r,complete:n}=t;return this.subscribe(e,r,n)}let n;"function"==typeof e?n=this._errorSubject.subscribe(e):e=ln;const o={complete:()=>{n&&(n.unsubscribe(),"function"==typeof r&&r())}};return"function"==typeof e&&(o.error=e),"function"==typeof t&&(o.next=t),this._valueSubject.subscribe(o)}pipe(...t){return this._valueSubject.pipe(...t)}}const gn=bn({action:"next",stage:"E_INITIAL"}),En=bn({action:"next",stage:"E_MAP_MERGE"}),wn=bn({action:nn,stage:"E_PRECOMMIT"}),jn=bn({action:nn,stage:"E_COMMIT"}),Sn=bn({action:nn,stage:"E_RESTRICT"}),mn=bn({action:"A_DELETE",stage:"E_COMMIT"}),xn=bn({action:"next",stage:"E_COMMIT"}),On=bn({action:"next",stage:"E_PRECOMMIT"});class Tn extends _n{constructor(t,e={}){super(t,e),this.debugTrans=!!e.debugTrans;const{filter:r,finalize:n}=e;"function"==typeof r&&this.filter(r),"function"==typeof n&&this.finalize(n),this._watchEvents()}setStages(t,e){if(!Array.isArray(e)||!e.length)throw new Error("setStages requires a non-empty array");this._eventTree.set(t,e)}get _eventTree(){return this._$eventTree||(this._$eventTree=new Map(sn)),this._$eventTree}get _eventSubject(){return this._$eventSubject||(this._$eventSubject=new m,this._$eventSubject.subscribe(t=>{this._lastEvent=t},ln)),this._$eventSubject}_watchEvents(){this.when(t=>{this._updateValue(t.value),t.complete()},xn)}filter(t){return this.on(e=>{try{const r=t(e.value,e,this);e.next(r)}catch(t){this.debugFilter&&console.log("error thrown in filter:",t,"in event",e),e.error(t,e)}},"next","E_FILTER")}finalize(t){return this.when(t,On)}on(t,e="next",r="E_FILTER",n=cn){if("function"!=typeof t)throw an("on() requires function",t);if("function"==typeof e)return this.when(t,e);const o=bn({action:e,stage:r,value:n});return this.when(t,o)}when(t,e){if("function"!=typeof t)throw an("when() requires function",t);const r=this,n=this._eventSubject.pipe(Z(t=>{try{return e(t)}catch(e){return console.log("filter error: ",e),t.error(e),!1}}));return n.subscribe(e=>{try{t(e,r),this.debug&&console.log("when:performed ",e.toString(),t.toString())}catch(r){this.debug&&console.log("---- when:error performed ",t.toString(),": ",r.message),e.error(r)}},ln),n}send(t,e,r){const n=r||this._eventTree.get(t)||this._eventTree.get("A_ANY"),o=this._errorSubject.next.bind(this._errorSubject),i=new dn(e,{action:t,stages:n[0],target:this});var s,u;return i.subscribe({error:o}),(s=n,u?J(s,u):s instanceof g?s:new g(H(s))).pipe(z(t=>(i.stage=t,i)),Z(t=>!t.isStopped)).subscribe({next:t=>this._eventSubject.next(t),error:t=>{console.log("error in fromEffect:",t.message)},complete(){i.isStopped||i.complete()}}),i}next(t){this.send("next",t)}get _transSubject(){return this._$transSubject||(this._$transSubject=new O(new Set)),this._$transSubject}remTrans(t){if(!t)return;const e=this._transSubject.value;e.delete(t),this._transSubject.next(e)}trans(t,e=1e3){"number"==typeof t&&(e=t,t=null),t||(t=new m),e>0&&(t=t.pipe(ct(e))),0===e&&("function"==typeof requestAnimationFrame?requestAnimationFrame(()=>{t.isStopped||t.complete()}):t=t.pipe(ct(1)));const r=this._transSubject.value;r.add(t),this._transSubject.next(r);const n=this.remTrans.bind(this);return t.subscribe({error(){n(t)},complete(){n(t)}}),t}get _baseSubject(){if(!this._$baseSubject){this._$baseSubject=new O(null);const t=this._valueSubject,e=this._errorSubject,{debugTrans:r}=this;this._$baseSubjectObserver=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=void 0,n=void 0;return M(t[t.length-1])&&(n=t.pop()),"function"==typeof t[t.length-1]&&(r=t.pop()),1===t.length&&c(t[0])&&(t=t[0]),R(t,n).lift(new K(r))}(this._$baseSubject,this._transSubject).pipe(Z(([t,e])=>(r&&console.log("filtering trans: size = ",e.size),e.size<1)),z(([t])=>t)).subscribe({next(e){r&&console.log("passing on value to valueSubject: ",e),t.next(e)},error(t){e.next(t)},complete(){this._valueSubject.complete()}})}return this._$baseSubject}_updateValue(t){this._baseSubject.next(t)}}var An=At?At.isConcatSpreadable:void 0;var Mn=function(t){return Fe(t)||Xe(t)||!!(An&&t&&t[An])};var Pn=function t(e,r,n,o,i){var s=-1,u=e.length;for(n||(n=Mn),i||(i=[]);++s<u;){var c=e[s];r>0&&n(c)?r>1?t(c,r-1,n,o,i):$e(i,c):o||(i[i.length]=c)}return i};var In=function(t){return(null==t?0:t.length)?Pn(t,1/0):[]};function Rn(t,e){if(this.fieldSubjects.has(t))throw an("cannot redefine field subject "+t,{key:t,stream:e,target:this});this.fieldSubjects.set(t,e);const r=this,n=e.pipe(rt()).subscribe({next(e){r.set(t,e,!0)}});return n.add(e.subscribe({error(e){r.error(an(e,{fieldSubject:n,target:r,field:t}))}})),this.subscribe({complete(){n.unsubscribe()}}),e}function kn(t){Object.defineProperty(t.prototype,"addFieldSubject",{value:Rn}),Object.defineProperty(t.prototype,"fields",{get:function(){return"undefined"!=typeof Proxy?(this._fields||(this._fields=new Proxy(this,{get:(t,e)=>(t.fieldSubjects.has(e)||console.log("attempt to get undefined fieldSubject",e),t.fieldSubjects.get(e))})),this._fields):this._fieldObj}}),Object.defineProperty(t.prototype,"fieldSubjects",{get:function(){return this._fieldSubjects||(this._fieldSubjects=new Map),this._fieldSubjects}}),Object.defineProperty(t.prototype,"_fieldObj",{get:function(){const t={};return this._fieldSubjects.forEach((e,r)=>{t[r]=e}),t}})}var Cn=(...t)=>In(t).reduce((t,e)=>(e instanceof Map&&e.forEach((e,r)=>{t.set(r,e)}),t),new Map);const Nn=t=>{try{return Array.from(t.keys()).sort().join(",")}catch{return null}},zn=(t,e)=>{if(!(t instanceof Map&&e instanceof Map))return!1;if(t.size!==e.size)return!1;if(!t.size)return!0;const r=Nn(t),n=Nn(e);if(!r||!n||r!==n)return!1;let o=!0;return t.forEach((t,r)=>{o&&(o=Nr(t,e.get(r)))}),o};function $n(t){t.value instanceof Map||t.error("only accepts map values")}function Fn(t,e){const r=[...e.value.keys()];t.value.forEach((t,n)=>{if(!r.includes(n))throw an(`key ${n} must be present in ${r.join(", ")}`,e)})}const Ln=(t,e)=>{const r=Cn(e.valueNonTrans,t.value);t.isStopped||t.complete(),r._$from="SR_FROM_SET",e.next(r)},Vn=(t,e)=>{const r=t.value;t.subscribe({error:ln,complete(){e.fieldSubjects.has(r)&&(e.fieldSubjects.get(r).complete(),e.fieldSubjects.delete(r));const t=new Map(e.valueNonTrans);t.delete(r),e._baseSubject.next(t)}})},Dn=(t,e)=>{t.next(Cn(e.valueNonTrans,t.value))};class Un extends Tn{constructor(t,e){super(hn(t),e),this.setStages("next",un),this.setStages(nn,on),Zr(e,"noNewKeys")&&this.when(Fn,Sn),this._watchSet()}_watchSet(){this.when($n,wn),this.when(Dn,En),this.when($n,gn),this.when(Ln,jn),this.when(Vn,mn)}onField(t,e,r="E_PRECOMMIT"){const n=(t=>{const e=Array.isArray(t)?[...t]:[t],r="function"==typeof t?t:t=>e.includes(t);return t=>t instanceof Map&&("SR_FROM_SET"!==t._$from&&!![...t.keys()].find(r))})(e),o=bn({action:nn,value:n,stage:r}),i=this.when(t,o),s=bn({action:"next",stage:"E_PRE_MAP_MERGE",value:n}),u=this.when(t,s);return u.subscribe({complete:()=>i.complete(),error:t=>i.error(t)}),u}has(t){return this.value.has(t)}set(t,e,r){try{if(t instanceof Map)return this.send(nn,t);if(!r&&this.fieldSubjects.has(t)){this._lastEvent=null,this._lastError=null;const r=this.fieldSubjects.get(t);r._lastError=null,r._lastEvent=null,r.next(e);let n=this._lastEvent;if(!r._lastError||n&&n.thrownError||(n=r._lastEvent&&r._lastEvent.thrownError?r._lastEvent:{thrownError:r._lastError}),n)try{n.value}catch{return{value:cn,thrownError:n.thrownError}}return n}return this.send(nn,new Map([[t,e]]))}catch(t){console.log("error in set:",t)}}get(t){return this.value.get(t)}get object(){return[...this.value.keys()].reduce((t,e)=>{try{t[e]=this.get(e)}catch(t){}return t},{})}_valueProxy(){return new Proxy(this,{get:(t,e)=>t.get(e),set:(t,e,r)=>t.set(e,r)})}get my(){return"undefined"!=typeof Proxy?(this._myProxy||(this._myProxy=this._valueProxy()),this._myProxy):this.object}delete(t){this.send("A_DELETE",t)}watch(...t){const e=In(t),r="function"==typeof e[e.length-1]?e.pop():null,n=new Map;e.forEach(t=>{this.value.has(t)&&n.set(t,this.value.get(t))});const o=new O(n);return this.on(t=>{t.subscribe({complete:()=>{o.next(t.target.value)},error:ln})},"next","E_COMMIT"),o.pipe(z(t=>{const r=new Map;return e.forEach(e=>{t.has(e)&&r.set(e,t.get(e))}),r}),rt(r||zn))}}kn(Un);class qn extends _n{constructor(t,e){super(hn(t),e)}has(t){return this.value.has(t)}set(t,e,r){return t instanceof Map?this.next(t):!r&&this.fieldSubjects.has(t)?this.fieldSubjects.get(t).next(e):this.next(new Map([[t,e]])),this}get(t){return this.value.get(t)}get object(){return[...this.value.keys()].reduce((t,e)=>{try{t[e]=this.get(e)}catch(t){}return t},{})}_valueProxy(){return new Proxy(this,{get:(t,e)=>t.get(e),set:(t,e,r)=>t.set(e,r)})}get my(){return"undefined"!=typeof Proxy?(this._myProxy||(this._myProxy=this._valueProxy()),this._myProxy):this.object}get fields(){return"undefined"!=typeof Proxy?(this._fields||(this._fields=this._fieldProxy()),this._fields):this._fieldObj}get _fieldObj(){const t={};return this.fieldSubjects.forEach((e,r)=>t[r]=e),t}delete(t){const e=this.value,r=new Map(e);r.delete(t),this._updateValue(r)}next(t){if(!(t instanceof Map))throw new Error("ValueMapStreamFast.next() requires a Map input");this._updateValue(Cn(this.value,t))}}kn(qn);var Bn=function(t,e,r,n){for(var o=t.length,i=r+(n?1:-1);n?i--:++i<o;)if(e(t[i],i,t))return i;return-1};var Hn=function(t){return t!=t};var Gn=function(t,e,r){for(var n=r-1,o=t.length;++n<o;)if(t[n]===e)return n;return-1};var Yn=function(t,e,r){return e==e?Gn(t,e,r):Bn(t,Hn,r)};var Kn=function(t,e){return!!(null==t?0:t.length)&&Yn(t,e,0)>-1};var Wn=function(t,e,r){for(var n=-1,o=null==t?0:t.length;++n<o;)if(r(e,t[n]))return!0;return!1},Jn=Math.min;var Xn=function(t,e,r){for(var n=r?Wn:Kn,o=t[0].length,i=t.length,s=i,u=Array(i),c=1/0,a=[];s--;){var h=t[s];s&&e&&(h=Hr(h,ir(e))),c=Jn(h.length,c),u[s]=!r&&(e||o>=120&&h.length>=120)?new Te(s&&h):void 0}h=t[0];var l=-1,f=u[0];t:for(;++l<o&&a.length<c;){var p=h[l],b=e?e(p):p;if(p=r||0!==p?p:0,!(f?Me(f,b):n(a,b,r))){for(s=i;--s;){var d=u[s];if(!(d?Me(d,b):n(t[s],b,r)))continue t}f&&f.push(b),a.push(p)}}return a};var Qn=function(t){return t};var Zn=function(t,e,r){switch(r.length){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)},to=Math.max;var eo=function(t,e,r){return e=to(void 0===e?t.length-1:e,0),function(){for(var n=arguments,o=-1,i=to(n.length-e,0),s=Array(i);++o<i;)s[o]=n[e+o];o=-1;for(var u=Array(e+1);++o<e;)u[o]=n[o];return u[e]=r(s),Zn(t,this,u)}};var ro=function(t){return function(){return t}},no=function(){try{var t=te(Object,"defineProperty");return t({},"",{}),t}catch(t){}}(),oo=no?function(t,e){return no(t,"toString",{configurable:!0,enumerable:!1,value:ro(e),writable:!0})}:Qn,io=Date.now;var so=function(t){var e=0,r=0;return function(){var n=io(),o=16-(n-r);if(r=n,o>0){if(++e>=800)return arguments[0]}else e=0;return t.apply(void 0,arguments)}}(oo);var uo=function(t){return Ge(t)&&vr(t)};var co=function(t){return uo(t)?t:[]};ao=function(t){var e=Hr(t,co);return e.length&&e[0]===t[0]?Xn(e):[]},so(eo(ao,ho,Qn),ao+"");var ao,ho;function lo(t){t.value&&"object"==typeof t.value||t.error("only accepts map values")}class fo extends Object{}const po=(t,e)=>{const r=Array.from(Object.keys(t)),n=Array.from(Object.keys(e));return!!Nr(new Set(r),new Set(n))&&r.reduce((r,n)=>r&&e[n]===t[n],!0)};function bo(t,e){const r=[...e.value.keys()];t.value.forEach((t,n)=>{if(!r.includes(n))throw an(`key ${n} must be present in ${r.join(", ")}`,e)})}const vo=(t,e)=>{const r=new fo;if(Object.assign(r,e.valueNonTrans),Array.isArray(t.value)){const e=[...t.value];for(;e.length;){r[e.shift()]=e.shift()}}else Object.assign(r,t.value);t.complete(),e.send("next",r)},yo=(t,e)=>{const r=t.value;t.subscribe({complete(){e.fieldSubjects.has(r)&&(e.fieldSubjects.get(r).complete(),e.fieldSubjects.delete(r));const t={...e.value};delete t[r],e._baseSubject.next(t)}})},_o=(t,e)=>{const r={...e.value};Object.assign(r,t.value),t.next(r)};class go extends Tn{constructor(t,e){if("object"!=typeof t)throw new Error("ValueObjectStream requires an object as a starting value");super({...t},e),this.setStages("next",un),this.setStages(nn,on),Zr(e,"noNewKeys")&&this.when(bo,Sn),this._watchSet()}_watchSet(){this.when(lo,wn),this.when(_o,En),this.when(lo,gn),this.when(vo,jn),this.when(yo,mn)}onField(t,e,r="E_PRECOMMIT"){const n=function(t){const e=Array.isArray(t)?t:[t],r="function"==typeof t?t:t=>e.includes(t);return t=>!(!t||"object"!=typeof t)&&(!(t instanceof fo)&&Object.keys(t).find(r))}(e),o=bn({action:nn,value:n,stage:r}),i=this.when(t,o),s=bn({action:"next",stage:"E_PRE_MAP_MERGE",value:n});return this.when(t,s).subscribe({complete:()=>i.complete(),error:t=>i.error(t)})}has(t){return t in this.value}set(t,e,r){if("object"==typeof t)return this.send(nn,t);if(!r&&this.fieldSubjects.has(t)){this._lastEvent=null,this._lastError=null;const r=this.fieldSubjects.get(t);r._lastError=null,r._lastEvent=null,r.next(e);let n=this._lastEvent;if(!r._lastError||n&&n.thrownError||(n=r._lastEvent&&r._lastEvent.thrownError?r._lastEvent:{thrownError:r._lastError}),n)try{n.value}catch{return{value:cn,thrownError:n.thrownError}}return n}return this.send(nn,{[t]:e})}get(t){return this.value[t]}get object(){return{...this.value}}_valueProxy(){return new Proxy(this,{get:(t,e)=>t.get(e),set:(t,e,r)=>t.set(e,r)})}get my(){return"undefined"!=typeof Proxy?(this._myProxy||(this._myProxy=this._valueProxy()),this._myProxy):this.object}delete(t){this.send("A_DELETE",t)}watch(...t){const e=In(t),r="function"==typeof e[e.length-1]?e.pop():null,n=new Map;e.forEach(t=>{t in this.value&&(n[t]=this.value[t])});const o=new O(n);return this.on(t=>{t.subscribe({complete:()=>{o.next(t.target.value)}})},"next","E_COMMIT"),o.pipe(z(t=>{const r={};return e.forEach(e=>{e in t&&(r[e]=t[e])}),r}),rt(r||po))}}return kn(go),{...fn,addActions:yn,matchEvent:bn,Event:dn,ValueStream:Tn,ValueStreamFast:_n,ValueMapStream:Un,ValueMapStreamFast:qn,ValueObjectStream:go,setProxy:function(t){if("undefined"!=typeof Proxy){return new Proxy(new Set,{get(e,r){if(r in e)return"function"==typeof e[r]?(...n)=>{t(r,n,cn);const o=e[r].apply(e,n);return t(r,n,o),o}:e[r]}})}return new Set}}}));
