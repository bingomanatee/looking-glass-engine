(function(a,b){'object'==typeof exports&&'object'==typeof module?module.exports=b():'function'==typeof define&&define.amd?define('freactal3',[],b):'object'==typeof exports?exports.freactal3=b():a.freactal3=b()})('undefined'==typeof self?this:self,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=1)}([function(a){a.exports=require('rxjs')},function(a,b,c){a.exports=c(2)},function(a,b,c){'use strict';Object.defineProperty(b,'__esModule',{value:!0});var d=c(3),e=c.n(d),f=(a)=>{a.constant('STORE_STATE_UNSET_VALUE',Symbol('STORE_STATE_UNSET_VALUE')),a.constant('S_NEW',Symbol('S_NEW')),a.constant('S_STARTED',Symbol('S_STARTED')),a.constant('S_STOPPED',Symbol('S_STOPPED')),a.constant('S_STARTING',Symbol('S_STARTING')),a.constant('S_ERROR',Symbol('S_ERROR')),a.constant('ACTION_ERROR',Symbol('ACTION_ERROR')),a.constant('ACTION_START',Symbol('ACTION_START')),a.constant('ACTION_WORKING',Symbol('ACTION_WORKING')),a.constant('ACTION_NOOP',Symbol('ACTION_NOOP')),a.constant('ACTION_COMPLETE',Symbol('ACTION_COMPLETE')),a.constant('NOT_SET',Symbol('NOT_SET'))},g=c(0),h=c.n(g),i=c(4),j=c.n(i),k=(a)=>{a.factory('p',()=>(a,...b)=>new Promise(function(c,d){let e,f,g;e=null;var h=function(){try{return g=[f,e],g.result=f,g.error=e,c(g)}catch(a){return d(a)}},i=function(a){try{return e=a,h()}catch(a){return d(a)}};try{function c(){return h()}return'function'==typeof a?Promise.resolve(a(...b)).then(function(a){try{return f=a,c.call(this)}catch(a){return i(a)}}.bind(this),i):Promise.resolve(a).then(function(a){try{return f=a,c.call(this)}catch(a){return i(a)}}.bind(this),i)}catch(a){i(a)}})),a.factory('call',()=>(a,...b)=>a&&'function'==typeof a?a(b):null),a.factory('explodePromise',({NOT_SET:a,isPromise:b})=>(c)=>{let e=a,g=a;return b(c)?(e=(...a)=>[...a],g=(...a)=>[...a],c.then(e).catch(g)):c=new Promise((a,b)=>{e=a,g=b}),Object.assign([c,e,g],{done:e,fail:g,promise:c})}),a.factory('update',()=>function(a){return(b,...c)=>(d)=>{const e=a(b,...c)(d);return Object.assign({},d,e)}}),a.factory('obj',()=>(a,b)=>{const c={};return c[a]=b,c}),a.constant('NOOP',(b)=>b),a.factory('isPromise',()=>(a)=>!!a&&(!!(a instanceof Promise)||Promise.resolve(a)===a)),a.factory('functionCombine',({call:a})=>(b,c)=>(...d)=>new Promise(function(e,f){return Promise.resolve(a(b,...d)).then(function(){try{return e(a(c,...d))}catch(a){return f(a)}},f)})),a.factory('mergeIntoState',()=>(a)=>(b)=>Object.assign({},b,a)),a.factory('timeLimitObservable',()=>(a,b=1e3,c)=>{const d=Object(g.from)([!1,new Error(c||`took over ${b/1e3} secs`)]).pipe(Object(i.delay)(b));return Object(g.race)(a,d)})},l=c(5),m=c.n(l),n=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},o=(a)=>{a.factory('Store',({STORE_STATE_UNSET_VALUE:a,S_NEW:b,S_STARTING:c,S_ERROR:d,S_STOPPED:e,S_STARTED:f,NOT_SET:h,ChangePromise:i,isPromise:j})=>{class k{constructor(c={}){var d=c.state;let e=d===void 0?a:d;var i=c.starter;const j=i===void 0?h:i;var k=c.debug;var l=c.actions;const m=l===void 0?{}:l;e===a&&j===h&&(e={}),this.errorStream=new g.BehaviorSubject(!1);try{this.addActions(m),k!==void 0&&k&&(this.debugStream=new g.BehaviorSubject({source:'constructor',config:c})),this._state=e,this._starter=j,this._status=j===h?f:b}catch(a){this.onError(a)}this.stream=new g.BehaviorSubject({state:this.state,status:this.status})}get status(){return this._status}get state(){return this._state}addActions(a={}){const b=this.actions||{};a&&'object'==typeof a?Object.keys(a).forEach((c)=>{const d=a[c];b[c]=this.addAction(c,d)}):this.errorStream.next({source:'addActions',message:'bad actionsMap',mutators:a}),this.actions=b}addAction(a,b){return'function'!=typeof b&&(b=()=>b),(...c)=>this.update(()=>b(this,...c),{action:a||!0})}update(a,b=h){if(a instanceof i?this._log({source:'update',message:'received ChangePromise',change:a}):(a=new i(a,b),this._log({source:'update',message:'created ChangePromise',change:a})),a.status)return this._resolve(a);switch(this.status){case h:this.after('NotSet','status is not set'),this._delay(a);break;case c:if(a.status)return this._resolve(a);this._delay(a);break;case f:return this._resolve(a);break;case d:this.afterInitError({source:'update',message:'change requested of store after init error',change:a}),setTimeout(()=>a.reject(new Error('change requested of errored store')));break;case e:this.afterStop({source:'update',message:'change requested to stopped store',change:a}),setTimeout(()=>a.reject(new Error('change requested of stopped store')));break;default:console.log('unknown status:',this.status),a.reject(new Error(`change cannot resolve - state in unknown status ${this.status.toString()}`));}return a}_delay(a){this._log({source:'_delay',change:a});const b=this.stream.subscribe(()=>{switch(this.status){case f:b.unsubscribe(),this.update(a);break;case d:b.unsubscribe(),a.reject(this.initializationError||new Error('initialization error before change resolved'));break;case e:b.unsubscribe(),a.reject(this.initializationError||new Error('store stopped before change resolved'));break;default:}});return a}_resolve(a){switch(this._log({source:'_resolve',change:a}),this.status){case d:return a.reject(this.initializationError||new Error('initialization error before change resolved')),a;break;case e:a.reject(this.initializationError||new Error('store stopped before change resolved'));break;default:}if('function'==typeof a.value){let b;try{b=a.value({state:this.state,actions:this.actions})}catch(b){return this._log({source:'_resolve',message:'error from change function',error:b}),a.reject(b),this.errorStream.next({error:b,change:a}),a}return this._log({source:'_resolve',message:'changing state value to function result:',newState:b,change:a}),a.value=b,this._resolve(a)}return j(a.value)?(a.value.then((b)=>{a.value=b,this._resolve(a)}).catch((b)=>{a.reject(b)}),a):(a.status&&(this._log({source:'_resolve',message:'updating status',change:a}),this._status=a.status),a.value!==h&&'undefined'!=typeof a.value&&(this._state=a.value),this.stream.next({status:this.status,state:this.state}),this._log({source:'_resolve',message:'stream updated',change:a}),a.resolve(a.value),this._log({source:'_resolve',message:'change resolved',change:a}),a)}afterStart(a){return this.after('Start',a)}afterStop(a){return this.after('Stop',a)}afterInitError(a){return this.after('InitError',a)}after(a,b='tried to change'){return'string'==typeof b?this.after(a,new Error(b)):(a||(a=this._status.toString()),this.errorStream.next({source:`after${a}`,error:b}),b)}restart(a=h){let g;switch(this.status){case b:g=this.start();break;case c:g=this._startPromise;break;case f:g=this._startPromise||Promise.resolve(this.state);break;case d:g=this.update(a,{status:f});break;case e:g=this.update(a,{status:f});break;case h:g=this.update(a,{status:f});break;default:g=this.update(a,{status:f});}return this._startPromise=g,g}start(){if(this._log({source:'start'}),!this._startPromise)switch(this.status){case b:if(!this._starter)this._log({source:'start',message:'no starter - updating status'}),this._startPromise=this.update(h,{status:f});else{if('function'!=typeof this._starter)return this.onError('bad starter'),Promise.reject(new Error('bad starter'));this._resolve(new i(h,{status:c})),this._startPromise=this.update(this._starter,{status:f})}break;case c:return Promise.reject(this.afterStart('tried to initialize after starting'));break;case f:this._startPromise=Promise.resolve(this.state);break;case d:return Promise.reject(this.afterInitError('tried to initialize after error'));break;case e:return Promise.reject(this.afterStop('tried to initialize after stopped'));break;default:return console.log('strange status: ',this.status),Promise.reject(new Error(`strange status: ${this.status.toString()}`));}return this._startPromise}stop(a){return a?this.update(a,{status:e}):(this._status=e,Promise.resolve(this.state))}onError(){this._status=d,this.errorStream.next(new Error('bad starter'))}_log(a){if(this.debugStream)try{this.debugStream.next(n({},a,{status:this.status,state:m()(this.state)}))}catch(b){this.debugStream.next({info:a,status:this.status,state:this.state,_cloneError:b})}}}return k})},p=(a)=>{o(a)},q=(a)=>{a.factory('ChangePromise',({isPromise:a,NOT_SET:b})=>{let c=0;class d{constructor(a=b,d={}){'undefined'==typeof a&&(a=b),c+=1,this.id=c;this._resolved=!1,this.promise=new Promise((a,b)=>{this._done=a,this._fail=b}),this.change=a,this.value=a,this.info=d===b?{}:d}get resolved(){return this._resolved}get status(){return this.info?this.info.status||b:b}resolve(c=b){return this.resolved?this.promise:(c!==b&&(this.value=c),a(this.value))?this.value.then((a)=>this.resolve(a)):(this._resolved=!0,this._done(this.value),this.promise)}reject(a=b){if(this.resolved)return console.log('ChangePromise reject called with ',a,'after _resolve'),this.promise;this._resolved=!0,a!==b&&(this.error=a);try{this._fail(this.error)}catch(a){console.log('error:',a)}return this.promise}then(...a){return this.promise.then(...a)}catch(a){return this.promise.catch(a)}}return d}),a.factory('change',({ChangePromise:a})=>(b,c={})=>new a(b,c))},r=(a)=>{q(a)};c.d(b,'STORE_STATE_UNSET_VALUE',function(){return y}),c.d(b,'S_NEW',function(){return z}),c.d(b,'S_STARTED',function(){return A}),c.d(b,'S_STARTING',function(){return B}),c.d(b,'S_ERROR',function(){return C}),c.d(b,'ACTION_ERROR',function(){return D}),c.d(b,'ACTION_START',function(){return E}),c.d(b,'ACTION_NOOP',function(){return F}),c.d(b,'ACTION_COMPLETE',function(){return G}),c.d(b,'NOT_SET',function(){return H}),c.d(b,'Store',function(){return t}),c.d(b,'Engine',function(){return u}),c.d(b,'EngineMerger',function(){return v}),c.d(b,'update',function(){return w}),c.d(b,'mergeIntoState',function(){return x});var s=(()=>{const a=new e.a;return[f,r,k,p].forEach((b)=>b(a)),a})().container;const t=s.Store,u=s.Engine,v=s.EngineMerger,w=s.update,x=s.mergeIntoState,y=s.STORE_STATE_UNSET_VALUE,z=s.S_NEW,A=s.S_STARTED,B=s.S_STARTING,C=s.S_ERROR,D=s.ACTION_ERROR,E=s.ACTION_START,F=s.ACTION_NOOP,G=s.ACTION_COMPLETE,H=s.NOT_SET;console.log('Engine:',u)},function(a){a.exports=require('bottlejs')},function(a){a.exports=require('rxjs/operators')},function(a){a.exports=require('lodash.clonedeep')}])});
//# sourceMappingURL=index.js.map